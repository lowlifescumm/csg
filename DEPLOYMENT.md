# Cosmic Spiritual Guide - Render Deployment Guide

## Prerequisites

Before deploying to Render, ensure you have:
- A Render account
- OpenAI API key
- Stripe account with API keys
- GitHub repository with your code

## Environment Variables

Set these environment variables in your Render dashboard:

### Required Environment Variables

1. **DATABASE_URL** - Automatically provided by Render when you create a PostgreSQL database
2. **JWT_SECRET** - Automatically generated by Render (or set a custom secure string)
3. **OPENAI_API_KEY** - Your OpenAI API key for AI-powered readings
4. **STRIPE_SECRET_KEY** - Your Stripe secret key (starts with `sk_`)
5. **STRIPE_WEBHOOK_SECRET** - Your Stripe webhook secret (starts with `whsec_`)
6. **NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY** - Your Stripe publishable key (starts with `pk_`)
7. **NEXT_PUBLIC_BASE_URL** - Your app's URL (e.g., `https://your-app.onrender.com`)
8. **CRON_SECRET** - Automatically generated by Render (for cron job security)

### Optional Environment Variables

- **NODE_ENV** - Set to `production` (automatically set by Render)

## Database Setup

1. Create a PostgreSQL database in Render
2. The database connection string will be automatically provided as `DATABASE_URL`
3. Run the following SQL commands to set up your database schema:

```sql
-- Users table
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    role VARCHAR(20) DEFAULT 'user',
    stripe_customer_id VARCHAR(255),
    stripe_subscription_id VARCHAR(255),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Credits table
CREATE TABLE credits (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    credits INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Readings table
CREATE TABLE readings (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    type VARCHAR(50) NOT NULL,
    question TEXT,
    result JSONB NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Birth charts table
CREATE TABLE birth_charts (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    birth_date DATE NOT NULL,
    birth_time TIME,
    location VARCHAR(255) NOT NULL,
    latitude DECIMAL(10, 8),
    longitude DECIMAL(11, 8),
    chart_data JSONB NOT NULL,
    interpretation TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Subscriptions table
CREATE TABLE subscriptions (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    stripe_subscription_id VARCHAR(255) UNIQUE NOT NULL,
    status VARCHAR(50) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Horoscopes table
CREATE TABLE horoscopes (
    id SERIAL PRIMARY KEY,
    sign VARCHAR(20) NOT NULL,
    date DATE NOT NULL,
    content TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(sign, date)
);
```

## Deployment Steps

1. **Connect your GitHub repository to Render**
   - Go to Render dashboard
   - Click "New +" → "Web Service"
   - Connect your GitHub account and select the repository

2. **Configure the service**
   - **Name**: cosmic-spiritual-guide (or your preferred name)
   - **Environment**: Node
   - **Build Command**: `npm install && npm run build`
   - **Start Command**: `npm start`
   - **Plan**: Choose appropriate plan (Starter for testing, Standard for production)

3. **Set up the database**
   - Go to Render dashboard
   - Click "New +" → "PostgreSQL"
   - Name it `cosmic-spiritual-guide-db`
   - Choose appropriate plan

4. **Configure environment variables**
   - In your web service settings, go to "Environment"
   - Add all the required environment variables listed above
   - The `DATABASE_URL` will be automatically linked if you named your database correctly

5. **Deploy**
   - Click "Create Web Service"
   - Render will automatically build and deploy your application

## Post-Deployment Setup

1. **Set up Stripe webhooks**
   - Go to your Stripe dashboard → Webhooks
   - Add endpoint: `https://your-app.onrender.com/api/stripe-webhook`
   - Select events: `customer.subscription.created`, `customer.subscription.updated`, `customer.subscription.deleted`, `invoice.payment_succeeded`, `invoice.payment_failed`
   - Copy the webhook secret to your `STRIPE_WEBHOOK_SECRET` environment variable

2. **Update your app's base URL**
   - Set `NEXT_PUBLIC_BASE_URL` to your deployed app URL
   - Update any hardcoded URLs in your code

3. **Test the deployment**
   - Visit your app URL
   - Test user registration and login
   - Test a tarot reading
   - Test payment processing

## Troubleshooting

### Common Issues

1. **Build failures**
   - Check that all dependencies are in `package.json`
   - Ensure Node.js version compatibility

2. **Database connection issues**
   - Verify `DATABASE_URL` is set correctly
   - Check database is running and accessible

3. **Stripe webhook issues**
   - Ensure webhook URL is correct
   - Check webhook secret matches
   - Verify webhook events are selected

4. **OpenAI API issues**
   - Verify `OPENAI_API_KEY` is set correctly
   - Check API key has sufficient credits

### Monitoring

- Check Render logs for errors
- Monitor database performance
- Set up alerts for critical failures

## Security Considerations

- Never commit API keys to your repository
- Use environment variables for all sensitive data
- Enable HTTPS (automatic with Render)
- Regularly rotate API keys
- Monitor for suspicious activity

## Scaling

- Upgrade to higher Render plans as needed
- Consider database scaling options
- Monitor performance metrics
- Implement caching strategies
